{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  {% if messages %}
    <div>
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
  <h1>Storeroom Inventory</h1>
  <div class="mb-2">
    <input type="text" id="storeroomSearchBar" class="form-control mb-2" placeholder="Search by raw item, unit, or expiration..." autofocus>
  </div>
  <div class="mb-2">
    <label for="sortBy">Sort by:</label>
    <select id="sortBy" class="form-select d-inline-block w-auto">
      <option value="none">--</option>
      <option value="name">Raw Item</option>
      <option value="quantity">Quantity</option>
    </select>
    <button id="sortOrderBtn" class="btn btn-secondary btn-sm">Descending</button>
  </div>
  <div class="form-check mb-2">
    <input type="checkbox" class="form-check-input" id="showHidden">
    <label class="form-check-label" for="showHidden">Display hidden</label>
  </div>
  <table class="table table-striped" id="storeroomTable">
    <thead>
      <tr>
        <th>Raw Item</th>
        <th>Quantity</th>
        <th>Unit of Measurement</th>
        <th>Expiration Date</th>
        <th>Display</th>
        <th>Toggle Visibility</th>
      </tr>
    </thead>
    <tbody>
      {% for item in storeroom_list %}
        {% with entry=item.entry status=item.status raw_item=item.raw_item %}
        <tr class="storeroom-row{% if not entry.display %} hidden-item{% endif %}
            {% if status == 'expired' %}table-danger{% elif status == 'soon' %}table-warning{% endif %}">
          <td>{% if raw_item %}{{ raw_item.name }}{% else %}-{% endif %}</td>
          <td>{{ entry.quantity }}</td>
          <td>{% if raw_item %}{{ raw_item.unit_of_measurement }}{% else %}-{% endif %}</td>
          <td>{% if entry.expiration_date %}{{ entry.expiration_date }}{% else %}-{% endif %}</td>
          <td>
            {% if entry.display %}
              <span class="badge bg-success">Visible</span>
            {% else %}
              <span class="badge bg-secondary">Hidden</span>
            {% endif %}
          </td>
          <td>
            <button type="button"
                    class="btn btn-outline-primary btn-sm toggle-display-btn"
                    data-id="{{ entry.id }}"
                    data-display="{{ entry.display|yesno:'true,false' }}">
              Toggle
            </button>
          </td>
        </tr>
        {% endwith %}
      {% empty %}
        <tr>
          <td colspan="5">No items in storeroom.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Search bar logic
    const searchBar = document.getElementById('storeroomSearchBar');
    searchBar.addEventListener('input', function() {
      const query = searchBar.value.toLowerCase();
      document.querySelectorAll('#storeroomTable tbody tr').forEach(function(row) {
        const rawItem = row.children[0].innerText.toLowerCase();
        const unit = row.children[2].innerText.toLowerCase();
        const expiration = row.children[3].innerText.toLowerCase();
        if (rawItem.includes(query) || unit.includes(query) || expiration.includes(query)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    });

    // Hide hidden items by default
    const showHidden = document.getElementById('showHidden');
    showHidden.addEventListener('change', function() {
      document.querySelectorAll('.hidden-item').forEach(function(row) {
        row.style.display = showHidden.checked ? '' : 'none';
      });
    });
    document.querySelectorAll('.hidden-item').forEach(function(row) {
      row.style.display = 'none';
    });

    // Sorting logic
    const sortBy = document.getElementById('sortBy');
    const sortOrderBtn = document.getElementById('sortOrderBtn');
    let descending = true; // default

    const table = document.getElementById('storeroomTable');
    const tbody = table.querySelector('tbody');
    const originalRows = Array.from(tbody.querySelectorAll('tr'));

    function getCellValue(row, idx) {
      return row.children[idx].innerText || row.children[idx].textContent;
    }

    function sortTable() {
      const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => row.style.display !== 'none');
      let idx = sortBy.value === 'name' ? 0 : (sortBy.value === 'quantity' ? 2 : null);

      if (sortBy.value === 'none' || idx === null) {
        // Restore original order
        originalRows.forEach(row => {
          if (row.style.display !== 'none') {
            tbody.appendChild(row);
          }
        });
        return;
      }

      rows.sort(function(a, b) {
        let valA = getCellValue(a, idx);
        let valB = getCellValue(b, idx);
        if (sortBy.value === 'quantity') {
          valA = parseFloat(valA) || 0;
          valB = parseFloat(valB) || 0;
        }
        if (valA < valB) return descending ? 1 : -1;
        if (valA > valB) return descending ? -1 : 1;
        return 0;
      });
      rows.forEach(row => tbody.appendChild(row));
    }

    sortBy.addEventListener('change', sortTable);
    sortOrderBtn.addEventListener('click', function() {
      descending = !descending;
      sortOrderBtn.textContent = descending ? 'Descending' : 'Ascending';
      sortTable();
    });

    // Initial sort
    sortTable();

    // AJAX toggle display
    document.querySelectorAll('.toggle-display-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const id = this.dataset.id;
        const currentDisplay = this.dataset.display === 'true';
        fetch('/inventory/storeroom/toggle-display/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({ id: id, display: !currentDisplay })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            location.reload();
          } else {
            alert('Failed to toggle display.');
          }
        });
      });
    });
  });
</script>
{% endblock %}