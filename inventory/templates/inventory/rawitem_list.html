{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h1>Raw Items</h1>
  <a href="{% url 'rawitem-add' %}" class="btn btn-success mb-2">Add Raw Item</a>
  <div class="mb-2">
    <input type="text" id="searchBar" class="form-control mb-2" placeholder="Search by name or description...">
    <label for="sortBy">Sort by:</label>
    <select id="sortBy" class="form-select d-inline-block w-auto">
      <option value="none">--</option>
      <option value="name">Name</option>
      <option value="price">Price</option>
    </select>
    <button id="sortOrderBtn" class="btn btn-secondary btn-sm">Descending</button>
  </div>
  <div class="form-check mb-2">
    <input type="checkbox" class="form-check-input" id="showHidden">
    <label class="form-check-label" for="showHidden">Display hidden</label>
  </div>
  <table class="table table-striped" id="rawItemsTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Description</th>
        <th>Price</th>
        <th>Unit of Measurement</th>
        <th>Display</th>
        <th>Edit</th>
      </tr>
    </thead>
    <tbody>
      {% for item in object_list %}
        <tr class="rawitem-row{% if not item.display %} hidden-item{% endif %}">
          <td>
            <a href="{% url 'rawitem-detail' item.pk %}">{{ item.name }}</a>
          </td>
          <td>{{ item.description }}</td>
          <td>{{ item.price }}</td>
          <td>{{ item.unit_of_measurement }}</td>
          <td>
            <input type="checkbox" disabled {% if item.display %}checked{% endif %}>
          </td>
          <td>
            <a href="{% url 'rawitem-edit' item.pk %}" class="btn btn-primary btn-sm">Edit</a>
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="5">No raw items found.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Search bar logic
    const searchBar = document.getElementById('searchBar');
    searchBar.addEventListener('input', function() {
      const query = searchBar.value.toLowerCase();
      document.querySelectorAll('#rawItemsTable tbody tr').forEach(function(row) {
        const name = row.children[0].innerText.toLowerCase();
        const desc = row.children[1].innerText.toLowerCase();
        if (name.includes(query) || desc.includes(query)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    });
    const showHidden = document.getElementById('showHidden');
    showHidden.addEventListener('change', function() {
      document.querySelectorAll('.hidden-item').forEach(function(row) {
        row.style.display = showHidden.checked ? '' : 'none';
      });
    });
    document.querySelectorAll('.hidden-item').forEach(function(row) {
      row.style.display = 'none';
    });

    // Sorting logic
    const sortBy = document.getElementById('sortBy');
    const sortOrderBtn = document.getElementById('sortOrderBtn');
    let descending = true; // default

    // Store original order
    const table = document.getElementById('rawItemsTable');
    const tbody = table.querySelector('tbody');
    const originalRows = Array.from(tbody.querySelectorAll('tr'));

    function getCellValue(row, idx) {
      return row.children[idx].innerText || row.children[idx].textContent;
    }

    function sortTable() {
      const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => row.style.display !== 'none');
      let idx = sortBy.value === 'name' ? 0 : 2;

      if (sortBy.value === 'none') {
        // Restore original order
        originalRows.forEach(row => {
          if (row.style.display !== 'none') {
            tbody.appendChild(row);
          }
        });
        return;
      }

      rows.sort(function(a, b) {
        let valA = getCellValue(a, idx);
        let valB = getCellValue(b, idx);
        if (sortBy.value === 'price') {
          valA = parseFloat(valA) || 0;
          valB = parseFloat(valB) || 0;
        }
        if (valA < valB) return descending ? 1 : -1;
        if (valA > valB) return descending ? -1 : 1;
        return 0;
      });
      rows.forEach(row => tbody.appendChild(row));
    }

    sortBy.addEventListener('change', sortTable);
    sortOrderBtn.addEventListener('click', function() {
      descending = !descending;
      sortOrderBtn.textContent = descending ? 'Descending' : 'Ascending';
      sortTable();
    });

    // Initial sort
    sortTable();
  });
</script>
{% endblock %}