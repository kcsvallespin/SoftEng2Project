{% extends "base.html" %}
{% load static %}
{% block title %}Sales History{% endblock title %}
{% block content %}

<h2>Sales History</h2>

<form method="get" id="sales-filter-form" style="margin-bottom: 20px;">
  <!-- Product selector -->
  <label for="product_id">Choose product:</label>
  <select name="product_id" id="product_id" required>
    <option value="">-- Select a product --</option>
    {% for product in products %}
      <option value="{{ product.variant_id }}" {% if selected and product.variant_id == selected.variant_id %}selected{% endif %}>
        {{ product.item.name }} - {{ product.sku }}
      </option>
    {% endfor %}
  </select>

  <!-- Date range inputs -->
  <label for="start_date">Start date:</label>
  <input type="date" name="start_date" id="start_date" value="{{ start_date|date:'Y-m-d' }}">

  <label for="end_date">End date:</label>
  <input type="date" name="end_date" id="end_date" value="{{ end_date|date:'Y-m-d' }}">

  <!-- Standard filter button -->
  <button type="submit">Show Sales</button>

  <!-- Quick filter buttons -->
  <button type="button" id="thisWeek">This Week</button>
  <button type="button" id="thisMonth">This Month</button>
  <button type="button" id="allTime">All Time</button>
</form>

<!-- Style for buttons -->
<style>
  #sales-filter-form button[type="button"] {
    margin-left: 5px;
    background: #f4f4f4;
    border: 1px solid #ccc;
    padding: 4px 10px;
    border-radius: 3px;
    cursor: pointer;
  }
  #sales-filter-form button[type="button"]:hover {
    background: #eaeaea;
  }
</style>

{% if selected %}
  <h3>Sales for "{{ selected.sku }}"</h3>
  <p>
    {% if start_date and end_date %}
      From <strong>{{ start_date|date:"Y-m-d" }}</strong> 
      to <strong>{{ end_date|date:"Y-m-d" }}</strong>
    {% else %}
      All Time
    {% endif %}
  </p>

  <!-- Total Sales Summary -->
  <p><strong>Total Sold:</strong> {{ total_sold }} units</p>

  <!-- Sales Table -->
  <table border="1" cellpadding="6" cellspacing="0">
    <tr>
      <th>Date</th>
      <th>Quantity Sold</th>
    </tr>
    {% for record in sales_by_day %}
      <tr>
        <td>{{ record.sale_date|date:"Y-m-d" }}</td>
        <td>{{ record.total_sold }}</td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="2">No sales data found for this product and date range.</td>
      </tr>
    {% endfor %}
  </table>

  <hr>

  <!-- Chart.js Graph -->
  <canvas id="salesChart" width="600" height="300"></canvas>

  <!-- JSON data for Chart.js -->
  {{ sales_by_day|json_script:"sales-data" }}

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const salesData = JSON.parse(document.getElementById('sales-data').textContent);

    const labels = salesData.map(record => record.sale_date);
    const data = salesData.map(record => record.total_sold);

    new Chart(document.getElementById('salesChart'), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Daily Sales',
          data: data,
          backgroundColor: 'rgba(54, 162, 235, 0.6)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  </script>

{% else %}
  <p>Please select a product to view sales data.</p>
{% endif %}

<!-- Script for quick filters -->
<script>
  function setDateRange(startDate, endDate) {
    const toDateInputValue = (date) => date.toISOString().split('T')[0];

    if (startDate && endDate) {
      document.getElementById('start_date').value = toDateInputValue(startDate);
      document.getElementById('end_date').value = toDateInputValue(endDate);
    } else {
      // Clear dates for All Time
      document.getElementById('start_date').value = '';
      document.getElementById('end_date').value = '';
    }

    document.getElementById('sales-filter-form').submit();
  }

  document.getElementById('thisWeek').addEventListener('click', () => {
    const today = new Date();
    const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, ...
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - dayOfWeek + 1); // Monday as first day
    const endOfWeek = new Date(today);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    setDateRange(startOfWeek, endOfWeek);
  });

  document.getElementById('thisMonth').addEventListener('click', () => {
    const today = new Date();
    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    setDateRange(startOfMonth, endOfMonth);
  });

  document.getElementById('allTime').addEventListener('click', () => {
    setDateRange(null, null); // Clear date filters
  });
</script>

{% endblock %}
