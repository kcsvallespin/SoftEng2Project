{% extends "base.html" %}
{% load static %}
{% block title %}Create Sale{% endblock title %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <h2 class="mb-4">Create Sale</h2>
    </div>
  </div>
  <div class="row">
    <div class="col-md-7">
      <div class="row row-cols-1 row-cols-md-2 g-4">
        {% for item in items %}
          <div class="col">
            <div class="card h-100 shadow-sm">
              {% if item.image %}
                <img src="{% if MEDIA_URL %}{{ MEDIA_URL }}{% else %}/media/{% endif %}{{ item.image }}" class="card-img-top" alt="{{ item.name }}" style="object-fit:cover; height:180px;">
              {% else %}
                <img src="{% static 'images/no-image.png' %}" class="card-img-top" alt="No image" style="object-fit:cover; height:180px;">
              {% endif %}
              <div class="card-body d-flex flex-column">
                <h5 class="card-title">{{ item.name }}</h5>
                <p class="card-text">{{ item.description|default:'No description.' }}</p>
                <button type="button" class="btn btn-primary mt-auto" onclick="document.getElementById('{{ item.item_id }}').showModal()">Select Varieties</button>
              </div>
            </div>
            <dialog id="{{ item.item_id }}">
              <h5>{{ item.name }} Varieties</h5>
              {% for item_variant in item.itemvariants.all %}
                <div class="d-flex align-items-center mb-2">
                  {% if item.name == item_variant.sku %}
                  <span class="me-2">{{ item_variant.sku }} - <strong>₱{{ item_variant.price }}</strong></span>
                  {% else %}
                  <span class="me-2">{{ item.name }} - {{ item_variant.sku }} - <strong>₱{{ item_variant.price }}</strong></span>
                  {% endif %}
                  <button type="button" class="btn btn-outline-secondary btn-sm me-1" onclick="decrementQuantity('{{ item_variant.pk }}')">-</button>
                  <input type="number" id="quantity-{{ item_variant.pk }}" name="quantity" data-name="{{ item_variant.sku }}" data-price="{{ item_variant.price }}" min="0" max="99" value="0" readonly style="width: 50px; text-align: center;">
                  <button type="button" class="btn btn-outline-secondary btn-sm ms-1" onclick="incrementQuantity('{{ item_variant.pk }}')">+</button>
                </div>
              {% endfor %}
              <div class="mt-3 d-flex justify-content-between">
                <button type="button" class="btn btn-success" onclick="collectSelectedItems('{{ item.item_id }}')">Add to Order</button>
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('{{ item.item_id }}').close()">Cancel</button>
              </div>
            </dialog>
          </div>
        {% endfor %}
      </div>
    </div>
    <div class="col-md-5">
  <div class="p-3 rounded" style="background: #f8f9fa; box-shadow: 0 1px 4px rgba(0,0,0,0.05);">
        <div class="card mb-3">
          <div class="card-header bg-primary text-white">Order Summary</div>
          <div class="card-body">
            <div id="order-summary" class="mb-0">
              <div class="text-muted">No items selected</div>
            </div>
            <div id="order-summary-total" style="display:none;">0.00</div>
          </div>
        </div>
  <form id="sale-info-form" class="mb-3">
          <div class="mb-2">
            <label for="customer_name" class="form-label">Customer Name</label>
            <input type="text" class="form-control" id="customer_name" maxlength="100" placeholder="Enter customer name">
          </div>
          <div class="mb-2">
            <label for="invoice_number" class="form-label">Invoice Number</label>
            <input type="text" class="form-control" id="invoice_number" maxlength="20" placeholder="Enter invoice number">
          </div>
          <div class="mb-2">
            <label for="tin" class="form-label">TIN</label>
            <input type="text" class="form-control" id="tin" maxlength="20" placeholder="Enter TIN">
          </div>
          <div class="mb-3">
            <label for="payment_type" class="form-label">Payment Type</label>
            <select class="form-select" id="payment_type" required onchange="togglePaymentFields()">
              <option value="" selected disabled>Select payment type</option>
              <option value="Cash">Cash</option>
              <option value="Card">Card</option>
              <option value="G-Cash">G-Cash</option>
            </select>
          </div>
          <div id="reference-number-group" class="mb-3" style="display:none;">
            <label for="reference_number" class="form-label">Reference Number</label>
            <input type="text" class="form-control" id="reference_number" maxlength="50" placeholder="Enter reference number">
          </div>
          <div id="cash-received-group" class="mb-3" style="display:none;">
            <label for="cash_received" class="form-label">Cash Received</label>
            <input type="number" class="form-control" id="cash_received" min="0" step="0.01" placeholder="Enter cash received" oninput="calculateChange()">
            <label for="change-display" class="form-label mt-2">Change</label>
            <input type="text" class="form-control text-success" id="change-display" readonly value="">
          </div>
        </form>
        <button type="button" class="btn btn-lg btn-success w-100" onclick="createSale()">Record Sale</button>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block javascript %}
  {{ block.super }}
  <script>
    window.create = {createSaleUrl: "{% url 'create_sale' %}", csrfToken: "{{ csrf_token }}"};

    function togglePaymentFields() {
      var paymentType = document.getElementById('payment_type').value;
      var cashGroup = document.getElementById('cash-received-group');
      var refGroup = document.getElementById('reference-number-group');
      if (paymentType === 'Cash') {
        cashGroup.style.display = '';
        refGroup.style.display = 'none';
      } else if (paymentType === 'G-Cash' || paymentType === 'Card') {
        cashGroup.style.display = 'none';
        refGroup.style.display = '';
      } else {
        cashGroup.style.display = 'none';
        refGroup.style.display = 'none';
        document.getElementById('change-display').value = '';
      }
    }

    function calculateChange() {
      var cashReceived = parseFloat(document.getElementById('cash_received').value);
      var totalPrice = 0;
      var totalElem = document.getElementById('order-summary-total');
      if (totalElem) {
        totalPrice = parseFloat(totalElem.textContent.replace(/[^\d.]/g, '')) || 0;
      }
      var change = cashReceived - totalPrice;
      var changeDisplay = document.getElementById('change-display');
      if (!isNaN(change) && totalPrice > 0) {
        changeDisplay.value = change >= 0 ? '₱' + change.toFixed(2) : '';
      } else {
        changeDisplay.value = '';
      }
    }
  </script>
  <script src="{% static 'js/sales/products-list.js' %}"></script>
  <script src="{% static 'js/sales/sales.js' %}"></script>
{% endblock javascript %}

